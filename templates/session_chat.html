<!DOCTYPE html>
<html>
<head>
    <title>Serenify Chat</title>
    <style>
        :root { --primary: #5fa393; --bg: #f3f6f5; }
        body { font-family: sans-serif; background: var(--bg); padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        .chat-box { flex: 1; background: white; border-radius: 15px; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 70%; font-size: 15px; }
        .sent { align-self: flex-end; background: var(--primary); color: white; border-bottom-right-radius: 2px; }
        .received { align-self: flex-start; background: #e2e8f0; color: #333; border-bottom-left-radius: 2px; }
        .input-area { margin-top: 15px; display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 25px; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 25px; cursor: pointer; }
    </style>
</head>
<body>

    <div class="chat-box" id="chatBox">
        {% for m in chat_messages %}
            <div class="msg {{ 'sent' if m.sender_id == current_user.id else 'received' }}">
                {{ m.message }}
            </div>
        {% endfor %}
    </div>

    <form class="input-area" method="POST">
        <input type="text" name="message" placeholder="Type a message..." required autocomplete="off">
        <button type="submit">Send</button>
    </form>

    <script>
        // Line 1: Request only the bubbles from the same route
        const refresh = () => fetch(window.location.href, { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => r.text()).then(html => { 
                const cb = document.getElementById('chatBox');
                cb.innerHTML = html; cb.scrollTop = cb.scrollHeight; 
            });

        // Line 2: Refresh every 3 seconds
        setInterval(refresh, 3000);

        // Line 3: Auto-scroll on first load
        window.onload = () => { document.getElementById('chatBox').scrollTop = 99999; };
    </script>

</body>
</html>